/*
 * Copyright 2020, 2021. Heekuck Oh, all rights reserved
 * 이 프로그램은 한양대학교 ERICA 소프트웨어학부 재학생을 위한 교육용으로 제작되었습니다.
 */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "rsa_pss.h"

static char *poet = "죽는 날까지 하늘을 우러러 한 점 부끄럼이 없기를, 잎새에 이는 바람에도 나는 괴로워했다. 별을 노래하는 마음으로 모든 죽어 가는 것을 사랑해야지 그리고 나한테 주어진 길을 걸어가야겠다. 오늘 밤에도 별이 바람에 스치운다.";
static char poet_e[256] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01};
static char poet_n[256] = {0xb9,0x63,0x5e,0x5b,0xd2,0x9b,0xdc,0x7b,0xc6,0x81,0xb0,0x6c,0xf5,0x1b,0x93,0x86,0x2f,0x58,0xc5,0x09,0x8a,0x87,0x22,0xb6,0x4a,0x52,0xc7,0x48,0xda,0xb7,0x92,0x81,0xed,0xdf,0xff,0xb1,0xb5,0xcf,0x63,0x3d,0x51,0x99,0x90,0x13,0xa2,0x92,0x89,0xcc,0x06,0xc8,0x27,0x48,0xd6,0x0d,0x8f,0x9d,0xbe,0x95,0x5c,0x87,0x3e,0xa4,0xfc,0x06,0x8e,0xbf,0x34,0x71,0x51,0x29,0x00,0x81,0x9d,0xe3,0x52,0x3e,0x75,0x5a,0x8f,0x17,0x61,0xec,0x7e,0x2e,0xb5,0xc3,0x98,0xf2,0x82,0xb6,0xa2,0x92,0x93,0x2b,0x12,0x73,0x21,0x01,0x02,0x4f,0x62,0xa3,0x1f,0x7f,0x8d,0x5e,0x53,0xf7,0xfc,0xda,0xfd,0x35,0xa5,0xc2,0xc9,0x47,0x82,0x67,0x18,0x19,0xc7,0x11,0x8f,0xf7,0x27,0x05,0x6c,0xf4,0xa5,0xb3,0x38,0x31,0x4a,0xe1,0x53,0x64,0xbc,0xab,0x95,0x78,0xf6,0x6f,0x37,0x9f,0xfb,0xe6,0x5a,0x59,0x2f,0x65,0x6d,0x89,0x5d,0xb3,0xaf,0xf6,0x24,0x9b,0xfe,0x6d,0x9b,0x49,0x45,0xd6,0x9f,0xec,0x28,0x9d,0xc8,0xfb,0x9f,0x74,0x58,0x0b,0xd5,0x47,0x59,0xe9,0x10,0x43,0xe0,0x68,0x73,0x74,0x19,0xa9,0x78,0x04,0xd3,0x32,0xda,0xf8,0x9c,0xed,0x63,0xd9,0x2d,0xc1,0x2b,0xc8,0x80,0x36,0xb4,0x3c,0xae,0x6c,0xfe,0x1a,0x0e,0x57,0xdc,0x30,0x3d,0x43,0x63,0x14,0x97,0x0e,0xac,0xe6,0xd2,0xff,0x5c,0xce,0x5b,0x28,0x31,0xc1,0xd9,0x9b,0x69,0x92,0x55,0xd4,0xd8,0x23,0x06,0x63,0x45,0xa8,0xe2,0xe3,0xfe,0x4a,0x3a,0xc2,0x6a,0x8b,0xc3,0x09,0x8f,0x1a,0xd7,0xc9,0xa1,0xb9};
static char poet_s[256] = {0x01,0x88,0x69,0x2c,0x3f,0x77,0x2c,0x29,0xc0,0x40,0xcd,0x8e,0xbe,0x16,0xf1,0x8d,0x60,0x2d,0xaa,0xde,0x26,0xf4,0xfb,0xf6,0x86,0xe8,0x2e,0xc8,0x78,0x7c,0xee,0x23,0xc5,0xed,0x37,0xc4,0xab,0xdf,0x2e,0x0e,0x21,0x0e,0x12,0x31,0xb6,0x22,0xb6,0x31,0x32,0x5f,0xf8,0x49,0x50,0xcb,0xb1,0xe6,0x38,0xa8,0x04,0xbe,0x20,0x8c,0x1b,0x30,0xbb,0xa2,0x2d,0x37,0x9d,0xf5,0xd5,0xdc,0xf3,0x78,0xff,0x6e,0x53,0xcb,0xd6,0x09,0x36,0xbf,0x51,0x48,0xba,0x9e,0x6a,0x01,0x54,0x1d,0xa7,0x4c,0xe5,0xe4,0x2e,0xc4,0x26,0x67,0xde,0xd8,0x98,0x81,0x93,0xe2,0x4b,0x7c,0x92,0x77,0x3c,0x21,0xf5,0x92,0x2f,0x9b,0xe1,0x5e,0x8c,0xe5,0x2c,0x4f,0x0d,0xaf,0x88,0x03,0xc3,0xda,0x69,0x64,0x32,0xd8,0xf2,0xd8,0xbf,0xc8,0x5d,0xeb,0x8f,0x92,0x80,0x59,0xf1,0x8e,0x2f,0x76,0x3a,0x68,0x83,0xbc,0x8e,0x13,0x16,0xa4,0x0f,0xef,0x2d,0x22,0x97,0xa7,0x24,0x31,0x70,0x84,0xef,0xa2,0x8a,0x90,0x77,0x83,0x08,0x6c,0x1b,0x3f,0x1a,0xa3,0xb1,0xe9,0xb4,0xf6,0x74,0x80,0xbd,0x99,0x03,0x6d,0xd7,0x65,0x91,0x99,0x66,0x35,0x28,0xe5,0x0f,0xb4,0xe1,0x79,0x5a,0x73,0x32,0x9d,0x1a,0x2a,0x4f,0xe2,0x7b,0xf4,0xc6,0xd4,0x19,0x03,0xed,0x8c,0x91,0xff,0x85,0x78,0xd7,0x70,0xc1,0xef,0x9f,0xfa,0x44,0x97,0xd4,0x4d,0x3a,0xf7,0x1e,0xbf,0x0c,0x43,0x6c,0x31,0x5a,0x63,0xbd,0xbc,0xd5,0x0d,0xe1,0x67,0x96,0x78,0x48,0x44,0x45,0x39,0x86,0xd8,0x70,0xa6,0xcf,0x12,0x26,0x15};
static char poet_t[256] = {0x18,0x8e,0xee,0x7e,0x4f,0xd5,0xd2,0xd6,0xb1,0x63,0xec,0xb3,0x17,0x3a,0x11,0xf4,0x57,0xa4,0x7c,0xbe,0x61,0xb4,0xd1,0x30,0x31,0xbb,0x84,0x02,0x55,0x00,0x9a,0xc7,0xb2,0xd4,0xb0,0x16,0x48,0x62,0xf7,0x5d,0xdc,0xb7,0x0a,0x8f,0x01,0xa4,0xfb,0x1a,0x11,0xe4,0x20,0xdc,0x36,0x61,0xe2,0x21,0x19,0x24,0xa6,0x4a,0xfe,0x45,0xef,0x62,0x06,0x3b,0xc8,0xce,0x2e,0xc7,0x40,0xa9,0xe6,0x90,0x5c,0xe1,0xa8,0xb6,0x3e,0xe6,0x68,0xd2,0x43,0x86,0x16,0xae,0x50,0x28,0x45,0x98,0xbe,0xd8,0x46,0xae,0x28,0xc0,0xb1,0xba,0xb5,0xc8,0xe2,0x7e,0x99,0x67,0x84,0xd7,0x56,0x91,0xa7,0x4a,0x0c,0x1a,0xb7,0xcd,0x26,0xc4,0xe9,0xdd,0xbe,0xed,0x61,0x21,0xea,0xf4,0xa2,0xa3,0x46,0xfc,0x25,0x36,0x9e,0x61,0xdb,0xf9,0x17,0x13,0x72,0x02,0x67,0x83,0xc1,0x81,0xbe,0x79,0x5a,0x77,0x88,0x0b,0x38,0x9c,0x98,0x28,0x71,0xbf,0x59,0x35,0xc2,0x85,0x31,0xb2,0xf7,0x1d,0xd3,0x78,0x3a,0x11,0xdf,0x62,0xe5,0xab,0x1b,0xed,0x73,0x5e,0xdf,0xb8,0x46,0x38,0xd2,0xfe,0x7a,0x77,0x44,0xe1,0xb5,0x1c,0x87,0x32,0x5c,0x83,0x4d,0x6b,0x13,0x4e,0xb3,0xba,0x32,0x1b,0xd7,0x24,0xb7,0x7a,0x8b,0xca,0xc7,0x1c,0xf5,0xa8,0x61,0x91,0x1c,0x5e,0xc0,0x46,0xb5,0x98,0x80,0xa6,0x18,0x97,0xb8,0xf5,0xe2,0x8d,0xfe,0x4f,0x0b,0x75,0x70,0x95,0xde,0xe3,0x3c,0x45,0x14,0x98,0x2c,0x2f,0x1d,0xf0,0x12,0x6b,0xe9,0x0e,0xfb,0x82,0x5e,0x35,0x78,0x7e,0xd3,0x55,0xfa,0x92,0x0f,0x6d};

int main(void)
{
    char e[RSAKEYSIZE/8], d[RSAKEYSIZE/8], n[RSAKEYSIZE/8];
    char s[RSAKEYSIZE/8];
    long x;
    int i, val, count = 0;

    /*
     * RSA keys
     */
    rsa_generate_key(e, d, n, 1);
    printf("e = ");
    for (i = 0; i < RSAKEYSIZE/8; ++i)
        printf("%02hhx", e[i]);
    printf("\nd = ");
    for (i = 0; i < RSAKEYSIZE/8; ++i)
        printf("%02hhx", d[i]);
    printf("\nn = ");
    for (i = 0; i < RSAKEYSIZE/8; ++i)
        printf("%02hhx", n[i]);
    printf("\n---\n");
    /*
     * Valid signature test
     */
    if ((val = rsassa_pss_sign("sample", 6, d, n, s)) != 0) {
        printf("Signature Error: %d -- FAILED\n", val);
        return 1;
    }
    printf("s = ");
    for (i = 0; i < RSAKEYSIZE/8; ++i)
        printf("%02hhx", s[i]);
    printf("\n");
    if ((val = rsassa_pss_verify("sample", 6, e, n, s)) != 0) {
        printf("Verification Error: %d -- FAILED\n", val);
        return 1;
    }
    printf("Valid Signature! -- PASSED\n---\n");
    /*
     * Invalid signature test
     */
    if ((val = rsassa_pss_sign("invalid sample", 14, d, n, s)) != 0) {
        printf("Signature Error: %d -- FAILED\n", val);
        return 1;
    }
    printf("s = ");
    for (i = 0; i < RSAKEYSIZE/8; ++i)
        printf("%02hhx", s[i]);
    printf("\n");
    if ((val = rsassa_pss_verify("invalid_sample", 14, e, n, s)) != 0)
        printf("Verification Error: %d, invalid signature -- PASSED\n---\n", val);
    else {
        printf("Verification Error -- FAILED\n");
        return 1;
    }
    /*
     * Wrong key test
     */
    if ((val = rsassa_pss_sign("sample", 6, e, n, s)) != 0) {
        printf("Signature Error: %d -- FAILED\n", val);
        return 1;
    }
    printf("s = ");
    for (i = 0; i < RSAKEYSIZE/8; ++i)
        printf("%02hhx", s[i]);
    printf("\n");
    if ((val = rsassa_pss_verify("sample", 6, e, n, s)) != 0)
        printf("Verification Error: %d -- PASSED\n", val);
    else {
        printf("Logic Error! -- FAILED\n---\n");
        return 1;
    }
    /*
     * Signature data error
     */
    if ((val = rsassa_pss_sign("It always seems impossible until it is done.", 44, d, n, s)) != 0) {
        printf("Signature Error: %d -- FAILED\n", val);
        return 1;
    }
    s[0] = s[1] = 0;
    printf("s = ");
    for (i = 0; i < RSAKEYSIZE/8; ++i)
        printf("%02hhx", s[i]);
    printf("\n");
    if ((val = rsassa_pss_verify("It always seems impossible until it is done.", 44, e, n, s)) != 0)
        printf("Verification Error: %d -- PASSED\n---\n", val);
    else {
        printf("Logic Error! -- FAILED\n");
        return 1;
    }
    /*
     * Compatibility test
     * Make sure that RSA key size is 2048 bits and SHA256 is used.
     */
    if ((val = rsassa_pss_verify(poet, strlen(poet), poet_e, poet_n, poet_s)) != 0) {
        printf("Compatibility Error: %d -- FAILED\n", val);
        return 1;
    }
    if ((val = rsassa_pss_verify(poet, strlen(poet), poet_e, poet_n, poet_t)) != 0)
        printf("Verification Error: %d, invalid signature -- PASSED\n", val);
    else {
        printf("Verification Error -- FAILED\n");
        return 1;
    }
    printf("Compatible Signature Verification! -- PASSED\n---\n");
    /*
     * Random test
     */
    printf("Random Testing"); fflush(stdout);
    rsa_generate_key(e, d, n, 0);
    do {
        arc4random_buf(&x, sizeof(long));
        if ((val = rsassa_pss_sign(&x, sizeof(long), d, n, s)) != 0) {
            printf("Signature Error: %d -- terminated\n", val);
            return 1;
        }
        if ((val = rsassa_pss_verify(&x, sizeof(long), e, n, s)) != 0) {
            printf("Verification Error: %d -- terminated\n", val);
            return 1;
        }
        if (++count % 0xff == 0) {
            printf(".");
            fflush(stdout);
        }
    } while (count < 0xfff);
    printf("No error found! -- PASSED\n");
    return 0;
}
